# 4 診断方法について
## 4.1 Proxy機能
### 4.1.1 Proxyを利用した通信キャプチャ
一般的なクライアントProxytoolに関する説明
MITMやっているようなお決まりの絵と内容を説明をするイメージ
見るだけじゃなくて変更もできるよ。SSLもイケますよ。みたいなことを書く。

### 4.1.2 Proxyタブの構成
Proxyタブを構成する各タブに関する簡単な概要の説明
- Intercept
- HTTP history
- WebSockets history
- Options

## 4.2 Burp Suiteによる通信のキャプチャ
### 4.2.1 通信をキャプチャしてみよう！
1. ブラウザでアクセスする(※この時以下二点の設定状況を確認)
  - ブラウザ側で、3章で説明したProxy設定がされていること
  - 「Intercept」タブが「Intercept is off」と設定されていること
2. 「HTTP hisotry」タブで通信内容を閲覧  
  「HTTP hisotry」タブの画面構成及び見方について説明
  上部フィールドについての説明(以下の情報が表示されている)
    - Host
    - Method
    - URL
    - Params
    - Edited
    - Status
    - Length
    - MIME type
    - Extension
    - title
    - Comment
    - SSL
    - IP
    - Cookies
    - Time
    - Listener port

  選択すると下部タブにRequest＆Pesponseデータの詳細を閲覧できる
  下部タブの詳細について説明(Requestタブと Pesponseタブ)
  以下タブにて項目ごとにデータを表示可能
    - Raw
    - Params
    - Headers
    - Hex

  Filetr機能の説明

### 4.2.2 値を書き換えて送信してみよう！
1. ブラウザでアクセスする(※この時以下二点の設定状況を確認)
  - ブラウザ側で、3章で説明したProxy設定がされていること
  - 「Intercept」タブが「Intercept is on」と設定されていること
2. 「Intercept」タブで値を変更  
「Intercept」タブの画面構成及び見方について説明
  - 上部ボタン
    - Forward
    - Drop
    - Intercept on or off
    - Action
  - 下部タブ
    - Raw
    - Params
    - Headers
    - Hex
3. 「HTTP hisotry」タブで結果を閲覧  
「Edited request」のタブに関する説明    
requestだけじゃなくてresponseのインターセプトについても補足する

## 4.3 その他

### 4.3.1 リクエストの再送信

検査では、リクエストを多数送信します。Repeaterを使用することで、HTTP Historyからコピーしたリクエストを送信したり、新規に作成したリクエストを送信することが出来ます。

#### 4.3.1.1 Historyからリクエストのコピー
1. Repeaterにコピーしたいリクエストを「HTTP History」で選択します。
2. 「Send To Repeater」を選択し、Repeaterにリクエストをコピーします。
3. Repeaterを開きます。

#### 4.3.1.2 リクエストの新規作成
1. Repeaterの「...」タブを選択します。
2. 右上にある「Target」をクリックします。接続先を入力する画面が表示されます。「Host」、「Port」を入力し、「OK」ボタンを押します。HTTPSでの接続を行う場合は、「Use HTTPS」にチェックを入れます。

#### 4.3.1.3 リクエストの編集、送信
1. 編集したいリクエストのタブを選択します。
2. 「Request」の「RAW」タブでは生のHTTPリクエストを直接編集できます。
「Request」の「Params」タブではパラメーターを表形式で表示し、変更できます。「Type」を変更することで、パラメーターの位置を変更できます。例えば、「Type」を「Body」から「Cookie」に変更することで、ボディパラメーターをCookieに移動することが出来ます。「Add」ボタンを押すとパラメーターを追加できます。「Remove」ボタンを押すと選択しているパラメーターを削除できます。「Up」ボタン、「Down」ボタンを押すとパラメーターを送信する順番を変更できます。
「Request」の「Headers」タブではヘッダーを表形式で表示し、変更できます。「Add」ボタンを押すとヘッダーを追加できます。「Remove」ボタンを押すと選択しているヘッダーを削除できます。「Up」ボタン、「Down」ボタンを押すとヘッダーを送信する順番を変更できます。
「Request」の「Hex」タブではリクエストをHexで確認、編集できます。
3. 右上にある「Target」をクリックすると、接続先を変更できます。
4. 「Go」ボタンを押し、リクエストを送信します。

#### 4.3.1.4 レスポンスの確認
1. 「Response」の「Raw」タブでは生のHTTPレスポンスを確認できます。
2. 「Response」の「Headers」タブではヘッダーを表形式で表示します。
「Response」の「Hex」タブではレスポンスをHexで表示します。
「Response」の「Render」タブではResponseがHTMLの場合、レスポンスをレンダリングし表示します。

### 4.3.2 Scope設定

検査対象外のアプリケーションに対して検査を実施してはいけません。誤って検査対象外のサーバー、URLを検査しないようにScopeを設定します。
Scopeを設定することで、Burpの動作に以下のような制限がかかります。

・Scopeで設定した条件を満たさないリクエストをProxy Historyに表示しないように出来ます。
・Scopeで設定した条件を満たすリクエストのみをInterceptして、リクエストの改ざんが出来るようにします。
・Scopeで設定した条件を満たさないリクエストをSpiderの開始URLとしようとすると、Scopeに追加することを確認するポップアップが表示されます。

Include in scope
ここに記述された条件はスコープ内として認識されます。

Exclude from scan
ここに記述された条件を満たすリクエストはスコープ外として認識されます。

#### 4.3.2.1 Scopeへの追加
Scopeの追加は2つ方法があります。
1. 「Add」ボタンを使用する
2. 「Paste URL」ボタンを使用する

「Add」ボタンを使用する
1. 「Add」ボタンを押します。
2. 「Host or IP range」、「Port」、「File」を正規表現で記述します。
3. 「OK」ボタンを押します。

「Paste URL」ボタンを使用する
1. スコープに含めたいURLをCntl+Cでコピーします。
2. 「Paste URL」ボタンを押します。

#### 4.3.2.1 Scopeからの削除
1. 削除したい条件を選択します。
2. 「Remove」ボタンを押します。

### 4.3.3 サーバ証明書設定

暗号化通信（https://～）が必要なWebアプリケーションに、デフォルト設定のBurp Suiteでアクセスすると、ブラウザに送信された証明書が不正であることを伝えるセキュリティ警告画面が表示されます。

![Firefoxのセキュリティ警告画面](./img/chapter4.3.3-before_CA_install_firefox.png "Firefoxのセキュリティ警告画面")

図4-3-3-a Firefoxのセキュリティ警告画面

セキュリティ警告画面が表示される原因は、Burp Suiteが起動時に独自に生成したCA証明書により署名された自己署名証明書を接続に使用しているためです。

一時的に例外としてBurp Suite独自の証明書を受け入れると、暗号化されている通信内容をBurp Suite上で平文で確認することが可能になります。しかし、警告のたびに操作をするのは煩わしいうえに、Webアプリケーションの設定によっては、自己署名証明書を使用して接続できない場合があります。

そのため、暗号化通信を効率よく取り扱うために、Burp Suiteの独自CA証明書をOSあるいはブラウザにインポートする必要があります。

なお、FirefoxはCA証明書を独自に管理しています。そのため、WindowsとOS XおよびFirefoxの3パターンについて解説します。

#### 独自CA証明書の保存

すべてのパターンで共通する操作はBurp Suiteが生成した独自CA証明書の保存です。

1. ブラウザのプロキシ設定がBurp Suiteに接続するようになっていることを確認
1. http://burp/ にアクセスして「CA certificate」リンクをクリック
1. 任意の名前でCA証明書を保存

#### Windows

1. Windowsの「インターネットオプション」（inetcpl.cpl）→「コンテンツ」→「証明書」ボタンをクリック
1. 「インポート...」をクリックして証明書ファイルを選択し、証明書ストアから「信頼されたルート証明機関」を選択してインポート
1. 「セキュリティ警告」ダイアログで「はい」をクリック

#### OS X

OS Xの場合は「キーチェーンアクセス」アプリにより設定します。

1. 「Launchpad」→「その他」から「キーチェーンアクセス」アプリを起動
1. 左上の南京錠が閉じている場合はクリックしてパスワードを入力してロックを解除
1. 「キーチェーン」で「ログイン」を選択し、「分類」で「証明書」を選択
1. 「ファイル」→「読み込む...」で保存したCA証明書を読み込み
1. 読み込んだ「PortSwigger CA」をダブルクリック
1. 「▶信頼」を展開し、「この証明書を使用するとき」プルダウンリストで「常に信頼」を選択
1. パスワードを入力して「設定をアップデート」ボタンをクリック

#### Firefox

1. ブラウザの設定「オプション」→「詳細」→「証明書」→「証明書を表示...」クリックで「証明書マネージャ」を表示
1. 「インポート...」ボタンをクリックして保存した証明書を「開く」
1. 「証明書のインポート」ダイアログで「この認証局によるWebサイトの識別を信頼する」にチェックを入れて「OK」ボタンをクリック

### 4.3.4 ログ保存設定

1.[Options]-[Misc]-Logging]の設定
ALLとToolsの使い分け、RequestとResponse

2.ログの見方

3.[参考]Logger++の紹介

### 4.3.5 アップストリームProxy設定

1.背景
- 社内Proxyの図
  - Proxy Host
  - Proxy Port

2.設定
  - 具体的な設定値例(図)
    - Desitination Hostに*(ワイルドカード)入れる話は必須
    - 認証方式、ID/PWD

3.Burp特有の問題と対策
  - 名前解決遅くなる問題
  - Connection timeout待ちで遅い問題

### 4.3.6 Intruder

1.自動化の必要性

2.使い方
  - Instuderへの渡し方
    - History右クリックからのsend IntruderあるいはCtrl+i
  - Positions設定
    - 自動設定
    - 手動設定(微調整)
  - Payloads
    - Payload Type
    - Payload Options(Simple List)
  - 実行結果と見方

3.便利な使い方
  - Grep Match
  - Automatic Payload Position

### 4.3.7 Extender

- Extensionの取り込み方について記載する。
- BApp Storeの説明を記載する。
- Jython、JRubyの設定について記載する。
- APIについて記載する(具体的な内容は触れず、javadocがあるよ程度)
